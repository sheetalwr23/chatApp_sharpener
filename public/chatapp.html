<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
</head>
<style>
    .user-name {
        font-size: 12px;
        font-weight: 600;
        color: black;
        margin-left: -14px;
    }

    .msg-sending {
        float: right;
        width: 100%;
        position: relative;
        background-color: #e04a5ae0;
        padding: 4px 22px;
        color: #fff;
        border-radius: 3px;
        margin: 10px 0;
    }

    .msg-receving {
        float: left;
        width: 100%;
        background-color: cadetblue;
        padding: 4px 22px;
        color: #fff;
        border-radius: 3px;
        margin: 10px 0;
    }

    .main-chat-area {
        overflow-y: auto;
        max-height: 89%;
    }

    .stick-bottom {
        position: absolute;
        bottom: 0;
        width: 100%;
        background-color: #e8e5e5;
        padding: 10px 20px 10px 2px;
        margin: 0;
    }

    .chat-area {
        border: solid 1px #ccc;
        border-radius: 5px;
        height: 600px;
        position: relative;
        width: 700px;
        /* box-shadow: 4px 4px 4px 4px rgb(207, 246, 224); */
        margin-top: 4px;
        padding: 0;
    }

    .sm1 {
        /* border: solid 1px #da9b9b; */
        height: 550px
    }

    .sm2 {
        /* border: solid 1px #0d0c0c; */
        height: 50px;

    }

    .message {
        width: 90%;
        padding: auto;
        margin: auto;
    }

    header {
        background-color: seagreen;
        width: 100%;
        padding: 8px;
        margin: auto;
        color: white;
        /* text-align: center; */
        font-size: 20px;
        font-weight: 800;
    }

    .list-group {
        margin: 4px;

    }

    .msg-text {
        margin: 4px;
        padding: 4px;
        padding-left: 8px;
        border-radius: 4px;
        width: 60%;
        
    }
    .sending-msg{
        float: right;
        background-color: rgb(243, 243, 250);
        border:1px solid lightblue;
    }
    .receiving-msg{
        float:left;
        background-color:rgb(235, 246, 235);
        border:1px solid lightgreen;
    }

    #contact-list {
        /* border: 2px solid grey; */
        width: 100%;
        height: 200px;
        /* margin: 4px;  */
    }

    ul {
        list-style: none;
        padding: 2px;
        margin: 2px;
        font-weight: bold;
    }

    #logOut {
        float: right;
        /* margin-top: 8px; */
       
    
    font-weight: bold; /* Make text bold */
    border: none; /* Remove button border */
    border-radius: 5px; /* Add button border radius */
    padding: 5px 10px;

    }

    .btn_create_group {
        margin: 4px;
        padding: 4px;
    }

    .bgcolor {
        position: relative;
        height: 70px;

        /* border: 2px solid black; */
        background-color: rgb(148, 218, 178);
        
      
        box-shadow: 3px 3px 3px 3px rgb(179, 228, 179);
    }

    #nav-heading {
        color: green;
        font-style: italic;
        font-size: 40px;
        font-weight: 800;
        margin-left: px;
    }

    .groupName {
        color: maroon;
        font-style: italic;
        list-style: disc;
    }

    .row-bg {
        background-color: whitesmoke;
        height: 40px;
        padding: 4px;

    }

    h5 {
        text-align: center;
        color: seagreen;
    }
    .logo-text
    {
        font-family: 'Your Chosen Font', sans-serif; /* Replace with the desired font family */
    font-size: 24px; /* Adjust the font size as needed */
    color:green; /* Change the color to your preference */
    
    letter-spacing: 4px; /* Adjust letter spacing for style */
    font-weight: bold; /* Make it bold */
    text-decoration: none;
    }
    .attach_img{
        height: 30px;
        width: 30px;
        margin:4px
    }
</style>

<body>
    <div class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid bgcolor">
            <div class="row w-100">
                <div class="col-6">
                    <a class="navbar-brand" href="./index.html">
                        <span class="logo-text">ChatApp</span>
                    </a>
                </div>
                <div class="col-6 text-right">
                    <a href="./index.html"><button class="btn btn-success" id="logOut" onclick="logout(event)">LogOut</button></a>
                </div>
            </div>
        </div>
    </div>
    



    <div class="container-fluid">
        <div class="row w-100 row-bg">

            <div class="col-md-3">
                <h5>Contact list</h5>
                <div id="contact-list">
                    <ul class="list-group" id="contact">
                    </ul>
                </div>


            </div>
            <div class="col-md-6 chat-area">
                <h5 id="chatWith"></h5>
                <div class="main-chat-area" id="main-chat-area">
                    <div id="sendChatMsg">

                    </div>

                </div>
                <div class="row stick-bottom">
                    <div class="col-md-10">
                        <input type="text" id="message-txt" class="form-control">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-success" onclick="sendMsg(event)">Send</button>
                    </div>
                    <div class="col-md-1">
                        <img
                        src="./images/attach.png"
                        alt="attachfile"
                        srcset=""
                        class="attach_img"
                        data-bs-toggle="modal"
                        data-bs-target="#attach_file"
                      />
                    </div>


                    <div class="modal fade" id="attach_file" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">Attach document</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="container mt-5">
                                        <!-- <h5>Create a New Group</h5> -->
                                        <form id="attach_fileForm">
                                            <div class="form-group">
                                                <label for="groupName">Select file</label>
                                                <input type="text" class="form-control" id="groupName" required>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary sent-files" onclick="attachFile(event)">send
                                        </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <h5>Your Groups</h5>
                <div id="display_group">
                    <div class="row">
                        <div class="col-md-6 justify-content-lg-start">
                            <button type="button" class="btn btn-success" onclick="removeSelectedMembers();"
                                data-bs-toggle="modal" data-bs-target="#createGroup">
                                + Add New
                            </button>
                        </div>
                    </div>
                    <!-- Button trigger modal -->


                    <!-- Modal -->
                    <div class="modal fade" id="createGroup" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">Create Your Group</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="container mt-5">
                                        <!-- <h5>Create a New Group</h5> -->
                                        <form id="createGroupForm">
                                            <div class="form-group">
                                                <label for="groupName">Group Name:</label>
                                                <input type="text" class="form-control" id="groupName" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Select Members:</label>
                                                <div class="user-list" id="userList">
                                                    <!-- User checkboxes will be added here dynamically -->
                                                    <!-- <label class="member_label"></label> -->
                                                </div>
                                            </div>
                                            <!-- <button type="submit" class="btn btn-primary">Create
        Group</button> -->
                                        </form>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="createGroup(event)">Save
                                        </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <ul id="group" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script> -->
<script src="http://localhost:2000/socket.io/socket.io.js"></script>


<script type="text/javascript">
//  const socket = io.connect('http://localhost:2000');
const socket = io();
 socket.on('receive-message', (messageData) => {
    // It will update the chat UI when a new message is received
    updateChatUIWithNewMessage(messageData);
});

function sendMessage(messageData) {
    // socket.emit('new-message', messageData);
}

socket.on('connection', (socket_id) => {
  
    const {userId} = parseJwt(localStorage.getItem('token'));
    console.log('userId :- ',socket_id);
    socket.emit('save-customer-details',{userId,socket_id});
});
socket.on('connection-done',(data)=>{

});

socket.on('received_msg',(data)=>{
    const {msg, to} = data;
    console.log('message received here :- ', data );
    const {id:toUser} = JSON.parse(localStorage.getItem('activeMessageUser'));
   
        messages.push({ msg: msg, type:'receiving' });
        displaySentMsg(messages);
 
})

    let groupEditData = {};
    let messages = [];
    async function sendMsg(event) {
        event.preventDefault();
        const msg = document.getElementById("message-txt").value;
        const {userId} = parseJwt(localStorage.getItem('token'));
        const {id:toUser} = JSON.parse(localStorage.getItem('activeMessageUser'));
        // const obj = { msg: msg };
        socket.emit('sendMessage',{from : userId, to:toUser,msg:msg});
        messages.push({ msg: msg, type:'sending' })
        displaySentMsg(messages);
        document.getElementById("message-txt").value = '';
        // try {
        //     const token = localStorage.getItem('token');
        //     const postMsg = await axios.post("http://localhost:2000/chat", obj, { headers: { "Authorization": token } });
        //     console.log("posted msg", postMsg.data.chatMsg);
        //     sendMessage(obj)
        //     fetchMsgFromGetAPi();
            
        // }
        // catch (err) {
        //     console.log("cant post", err)
        // }
    }


    //function to parse jwt token
    function parseJwt(token) {
        const base64Url = token.split('.')[1]; // Get the base64-encoded payload
        const base64 = base64Url.replace('-', '+').replace('_', '/'); // Replace URL-safe characters
        const payload = JSON.parse(atob(base64)); // Decode and parse the payload
        return payload;
    }
const iterateUserList = getData =>{
    const array = getData.data.all_users;
    document.getElementById("contact").innerHTML = '';
            const parent = document.getElementById("contact");
            const localTokenget = localStorage.getItem("token", getData.data.token);
            const decodedToken = parseJwt(localTokenget)

            array.forEach(element => {
                if (decodedToken.name != element.name) {
                    const child = document.createElement("li");
                    child.textContent = element.name;
                    const activeUser = JSON.parse(localStorage.getItem('activeMessageUser'));
                    child.className=activeUser?.id==element?.id?"active list-group-item":"list-group-item";
                    
                    parent.appendChild(child);
                    child.onclick=()=>{
                        localStorage.setItem('activeMessageUser',JSON.stringify(element));
                        showActiveUserDetails();
                        iterateUserList(getData);
                        fetchChatMessagesForOneUser(element);
                    }

                }
            });
}


async function fetchChatMessagesForOneUser({id}){
    const {userId} = parseJwt(localStorage.getItem('token'));
const data = await axios.get(`http://localhost:2000/chat-msg/${userId}/${id}`);
const msgs = data.data.chatMsg.map(dt=>{
    if(dt.from==userId){  dt.type='sending'; }
    else{ dt.type='receiving'}
    return dt;
});
console.log('here are fetched messages',msgs);
messages = msgs;
displaySentMsg(messages);
}



    async function getUserFromApi() {
        //get contacts other than logged in user
        try {
            const getData = await axios.get("http://localhost:2000/user");
            
          iterateUserList(getData)

        }
        catch (error) {
            console.log("can not get all uasers", error)
        }
    }
    window.addEventListener("DOMContentLoaded", async () => {
        //get users
        getUserFromApi();

        //get msgs from db and set to local storage
        fetchMsgFromGetAPi();

        //get msgs from local storage
        getMsgFromLocalStorage();

        //get groups 
        getGroupDetails()
        //get group members
        getGroupMembers();
    })
const showActiveUserDetails = () =>{
    const element = JSON.parse(localStorage.getItem('activeMessageUser'));
    document.getElementById("chatWith").innerHTML=element.name;
}
    //set msg to local storage
    async function fetchMsgFromGetAPi() {
        try {
            const token = localStorage.getItem('token');
            const getMsg = await axios.get("http://localhost:2000/chat", { headers: { "Authorization": token } });
            console.log("all messages", getMsg.data.chatMsg);
            const arrOfObj = getMsg.data.chatMsg;
            const string = JSON.stringify(arrOfObj);
            localStorage.setItem("msgs", string);
            getMsgFromLocalStorage();
        }
        catch (error) {
            console.log("cant show msg sent by user", error);
        }

    }
    function getMsgFromLocalStorage() {
        //get msgs from local storage
        const getFromLocalStorage = localStorage.getItem("msgs");
        
        const parsedMsgs = JSON.parse(getFromLocalStorage);
        console.log("parsed array from localstorage", parsedMsgs);
        displaySentMsg(parsedMsgs);
    }


   
    //display sent msg
    async function displaySentMsg(arrMsg) {
        document.getElementById("sendChatMsg").innerHTML = "";
        arrMsg.slice(-5).forEach((obj) => {
            const parent = document.getElementById("sendChatMsg");
            const child = document.createElement("div");
            child.className = obj.type==='receiving'?'msg-text receiving-msg': "msg-text sending-msg";
            child.textContent = `${obj.msg}`;
            parent.appendChild(child);
        })
    }

    function removeSelectedMembers() {
        groupEditData = { members: [] };
        getGroupMembers();
    }

    async function getGroupMembers() {
        try {
            const getData = await axios.get("http://localhost:2000/user");
            const array = getData.data.all_users;

            const token = localStorage.getItem('token');
            const decodename = parseJwt(token);
            // console.log('decodename',decodename);
            const userListDiv = document.getElementById("userList");
            userListDiv.innerHTML = '';

            const { members, groupname } = groupEditData;
            console.log('groupMembers', groupEditData);
            if (groupname) {
                document.getElementById('groupName').value = groupname;
            }
            else {
                document.getElementById('groupName').value = '';
            }


            array.forEach((ele, index) => {
                // Create a checkbox input element
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = ele.id; // Assign the user's name as the value
                if (decodename.userId == ele.id) {
                    checkbox.checked = true;
                    checkbox.disabled = true;
                }
                if (members.find(memb => memb.userId == ele.id)) {
                    checkbox.checked = true;
                }
                checkbox.className = "array-checkbox";

                // Create a label element for the checkbox
                const label = document.createElement("label");
                label.appendChild(checkbox); 
                label.appendChild(document.createTextNode(ele.name)); // Add user name text

               
                userListDiv.appendChild(label);
                userListDiv.appendChild(document.createElement("br")); 
            });

        } catch (err) {
            console.log("can not fetch users");
        }
    }


    function selectMembers() {
        const selectedUsers = [];
        const selectedUsersid = [];
        // getGroupMembers();
        const checkboxes = document.getElementsByClassName("array-checkbox");

        const checkboxesArray = Array.from(checkboxes);
        checkboxesArray.forEach((checkbox) => {
            if (checkbox.checked) {
                selectedUsers.push(checkbox.value);

            }
        });
        // console.log("selectedUsersid",selectedUsersid)
        return selectedUsers;
    }

    async function createGroup(event) {
        event.preventDefault();
        const groupName = document.getElementById("groupName").value;
        // Call selectMembers to collect the selected users
        selectMembers();

        console.log("Group Name:", groupName);
        console.log("Selected Users:", selectMembers());

        // Create an object that includes the selectedUsers and groupName
        const groupData = {
            groupName: groupName,
            members: selectMembers()
        };

        console.log("Group Data:", groupData);
        const token = localStorage.getItem('token');
        try {
            if (groupEditData.members.length <= 0) {
                const postGroup = await axios.post("http://localhost:2000/createGroup", groupData, {
                    headers: { "Authorization": token }
                });
            }
            else {
                const postGroup = await axios.put("http://localhost:2000/updateGroup/" + groupEditData.id, groupData, {
                    headers: { "Authorization": token }
                });
            }
            removeSelectedMembers();

            // Clear selectedUsers after successful post if needed
            selectMembers().length = 0;
            getGroupDetails();

            $('#createGroup').modal('hide');
        } catch (error) {
            console.error("Error posting data:", error);
        }
    }


    async function getGroupDetails() {
        try {
            const token = localStorage.getItem('token');
            const decodename = parseJwt(token);
            console.log("decodedtokenname", decodename.userId);
            const admin = decodename.userId;
            const getGroupDetails = await axios.get("http://localhost:2000/getGroup", { headers: { "Authorization": token } });

            const array = getGroupDetails.data.finalGroupMemMapping;
            displayGroup(array, admin);
            console.log("array", array)
        }
        catch (error) {
            console.log("can not get group details", error);
        }
    }
    function displayGroup(array, admin) {
        // const {allGroupData,groupmembers} = array; // getting both model data here

        const parent = document.getElementById("group");
        parent.innerHTML = '';
        array.forEach((obj) => {
            console.log("obj", obj.groupname);
            const child = document.createElement("li");
            child.textContent = `${obj.groupname}`;
            child.className = "list-group-item";
            parent.appendChild(child);
            //edit group
            if (admin == `${obj.createdBy}`) {
                const edit = document.createElement("button");
                // edit.type="text"
                edit.innerHTML = "Edit";
                edit.className = "btn"
                child.appendChild(edit);

                edit.onclick = () => {
                    // console.log('calling');
                    document.getElementById("group").value = obj.groupname;
                    groupEditData = obj;
                   
                    $('#createGroup').modal('show');

                    getGroupMembers();

                    // console.log("Hello Check it here : -", groupEditData);
                };
            }


        })


    }

    async function logout(event) {
        socket.disconnect();
        event.preventDefault()
        try {
            const token = localStorage.getItem("token");
            const decodeToken = parseJwt(token)
            const userId = decodeToken.userId
            const response = await axios.put(`http://localhost:2000/updateStatus/${userId}`)
            if (response.status === 200) {
                window.location.href = '/index.html'
            }
            else {
                console.log('getting error')
            }
        }
        catch (err) {
            console.log(err)
        }
    }

//file upload

//     $(document).ready(function () {
//     $("#send").click(function () {
//         var message = $("#message").val();
//         // Send the message to the chat area (you can customize this part)
//         $(".chat-messages").append("<p>You: " + message + "</p>");
//         $("#message").val(""); // Clear the input field
//     });

//     $("#fileInput").change(function () {
//         var file = this.files[0];
//         // Display the sent file in the sent-files area (you can customize this part)
//         $(".sent-files").append("<p>You sent a file: " + file.name + "</p>");

//         // You can also upload the file to your server using AJAX and handle it there.
//         // Here, we are just displaying a message for demonstration purposes.
//     });
// });

</script>

</html>