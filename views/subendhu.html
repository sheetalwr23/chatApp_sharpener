<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
*{
    margin: 0;
    padding: 0;
    
    /* background: linear-gradient(to bottom, #fbfbfb, white); */
}

        
       
        .navbar1{
            background-color: #00a884;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.6)
        }  

        .leftbody1{
            background-color: #fbfbfb;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.6)
        } 
        .rightcircle1{
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.6)
        }
        .rightcontactimg{
            background-color: #fbfbfb;
            height:95px;
            box-shadow: 4px 8px 8px rgba(13, 110, 253, 0.6)
        }
        .main1{
            background-image: url('/images/bgimg2.png');   
    background-size: 100vh 100vh ;
    background-repeat: no-repeat;
    
        }
        .row1{
            height: 650px;
            
        }
        .ico{
            color: red;
        }
        .messagebox{
            height: 480px;
            background-color: #efeae2;
        }
        .rightpan{
            background-color: #efeae2; 
        }
        .brand{
            color: white;
        }

        /* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 23px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(20px);
  -ms-transform: translateX(20px);
  transform: translateX(20px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

button{
    border-radius: 5%;
    margin: 0px;   
    border: 1px solid #0659ea;
}

.button1{    
    display: inline-block;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    text-align: center;
    text-decoration: none;   
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;    
    font-size: 1rem;
    border-radius: 0.25rem;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;

}
.dropdown-toggle::after {
    content: none;
}

            

    </style>
</head>
<body>    
    <nav class="navbar navbar-expand-lg navbar1 bg-gradient">        
        <div class="container-fluid"> 
            <div class="container d-flex ">
            <a class="navbar-brand fs-1 brand" style="font-family: 'Caprasimo', cursive;" href="/views/index.html">ChitChat</a>               
            <div class="collapse navbar-collapse justify-content-end" id="navbarTogglerDemo03">
                <div class="d-flex">
                     <!-- <button class="btn btn-success me-4" id="premiumbtn">Buy Premium</button>                        -->
                     <a href="login.html"><button class="btn btn-primary mx-3" id="logoutButton">Logout</button></a>                                        
                </div>           
          </div>
        </div> 
        </div>
      </nav>  
    <section>        
        <div class="container-fluid">                 
               <div class="row row1">
                <div class="col-lg-3 leftbody1  row1">
                    <div class="row  border-4 border-bottom bg-gradient py-2 ">
                        <div class="col-3 border-end  d-flex justify-content-center">
                            <i class="bi-person-circle text-center fs-1"></i>
                        </div>
                        <div class="col-6  pt-2 border-end">
                            <div id="userprofilename"></div>
                            <p id="profilestatusupdate"></p>
                        </div>
                        <div class="col-3 pt-2">
                            <div class="container">
                                <div class="row">
                        
                                    <div class="dropdown">
                                        <i class="fa-solid fa-ellipsis-vertical py-2 fs-3 dropdown-toggle" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false"></i>                
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                            <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo" href="#">New Group</a></li>
                                          <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#statusModal" data-bs-whatever="@mdo" href="#">Status</a></li>                  
                                          <li><a class="dropdown-item" href="#">Starred Message</a></li>
                                          <li><a class="dropdown-item" href="login.html">Log out</a></li>
                                        </ul>
                                    </div> 
                                    
                                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                          <div class="modal-content">
                                            <div class="modal-header">
                                              <h5 class="modal-title" id="exampleModalLabel">Create a Group</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                              <form method="post" onsubmit="createGroup(event)">                                                                                             
                                                <div class="mb-3">
                                                  <label for="proname" class="col-form-label">Add group name</label>
                                                  <input type="text" class="form-control" id="groupname">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="proname" class="col-form-label">Add group participant</label>
                                                    <div class="dropdown">
                                                      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                                        Select Participant
                                                      </button>                                                    
                                                      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdownItemList">
                                                        <!-- Dynamic items will be inserted here -->
                                                      </ul>
                                                    </div>
                                                  </div>
                                             
                                            </div>
                                            <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                              <button type="submit" class="btn btn-primary">Create</button>
                                            </div>
                                          </form>
                                          </div>
                                        </div>
                                      </div>
                                    
                                      <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                          <div class="modal-content">
                                            <div class="modal-header">
                                              <h5 class="modal-title" id="exampleStatusModalLabel">Edit Status</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                              <form  onsubmit="status1(event)">
                                                <div class="mb-3">
                                                  <label for="statusupdate" class="col-form-label">Add New Status</label>
                                                  <input type="text" class="form-control" id="statusupdate">
                                                </div>                                          
                                             
                                            </div>
                                            <div class="modal-footer">
                                              <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
                                              <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Create</button>
                                            </div>
                                          </form>
                                          </div>
                                        </div>
                                      </div>                         


                                  </div>
                                </div>
                        </div>
                    </div>        



                    <!-- All user list on left panel starts here  -->
                    <div class="row my-4">
                        <!-- <div class="col-3   d-flex justify-content-center">
                            <i class="bi-person-circle text-center fs-3"></i>
                        </div>   -->
                     <div class="col-12  border-end " id="alluserlist">
                       
                     </div>                     
                     <!-- <div class="col-3 d-flex align-items-center">
                        <i class="fa-solid fa-circle" style="color: #38c24f;"></i>
                     </div>   -->
                    </div>   
                
                </div>

                 <!-- All user list on left panel ends here  -->


                 <!-- Middle part with contact name and message box starts here -->
                <div class="col-lg-6 ">
                    <div class="row rightcontactimg border-4 border-bottom bg-gradient">
                        <div class="col-lg-10">
                            <div class="row py-3 " >
                                <div class="col-3 d-flex justify-content-center" id="onlineuserimg">
                                  
                                </div>
                                <div class="col-6  py-2 d-flex align-items-center" id="onlineusername">
                                    
                                                                  
                                </div>                               
                            </div> 
                        </div>
                        <div class="col-lg-2  d-flex align-items-center justify-content-between">
                            <i class="bi bi-search fs-5 "></i>
                            <i class="bi bi-heart fs-5 ico"></i>
                            <i class="bi bi-bell fs-5"></i>
                        </div>
                    </div>



                    <!-- message will be visible here  -->

                    <div class="row messagebox border-4 border-bottom bg-gradient  ">
                        <div class="col-12 py-5" id="groupdetails">
                            <ul id="messagebox">

                            </ul>
                        </div>
                    </div>

                    <!-- message visiblity will end here  -->
                    


                    <div class="row  ">
                        <div class="col-12 py-2 ">

                            <!-- user typing box starts here  -->
                            <!-- chat data though form -->
                            <form method="post" onsubmit="chatData(event)">
                                <div class="row">
                                    <div class="col-lg-9">
                                <input class="form-control" type="text" name="message" id="message">
                                    </div>
                                    <div class="col-lg-3">
                                    <button class="button1" type="submit"><i class="fa-solid fa-play fs-2" style="color: #0659ea;"></i></button>
                                    
                                <i class="bi bi-paperclip mx-1 fs-3"></i> 
                                <input type="file" id="chatFile" accept="image/*, video/*" />                               
                                <i class="bi bi-camera mx-1 fs-3" style="color: #0b5be5;"></i>
                                <i class="fa-regular fa-face-smile mx-2 fs-3" style="color: #3253f5;"></i>
                            </div>
                            </div>
                            </form>
                        </div>
                    </div>
                </div>

                 <!-- user typing box ends here  -->

                     <!-- Middle part with contact name and message box starts here -->



                <div class="col-lg-3 row1 border-4 border rightpan bg-gradient">
                    <div class="row bg-light border-4 border-bottom bg-gradient">
                        <div class="col-12  mt-1 d-flex justify-content-center">
                            <i class="fa-solid fa-circle-user text-center " style="color: #afacac; font-size: 100px; padding-top: 20px;"></i>
                        </div>
                        <div class="col-12  mt-2 d-flex  justify-content-center" id="useronline">                            
                                  
                            
                        </div>
                        <div class="col-12 mb-2 d-flex justify-content-center">                            
                            <p></p>                       
                        </div>
                    </div>
                    <div class="row mt-2 py-3 bg-light border-4 border-bottom bg-gradient">
                        <div class="col-12 d-flex justify-content-evenly">
                            <div class="border border-4 p-2 rightcircle1 rounded-circle">
                                <i class="fa-solid fa-comment" style="color: #206ef3; font-size: 25px"></i>
                            </div>
                            <div class="border border-4 p-2 rightcircle1 rounded-circle">
                                <i class="fa-solid fa-phone" style="color: #3d7ef0; font-size: 25px"></i>
                            </div>
                            <div class="border border-4 p-2 rightcircle1 rounded-circle">
                                <i class="fa-solid fa-video" style="color: #2868d7; font-size: 25px"></i>
                            </div>  

                        </div>
                    </div>
                    <div class="row mt-2 py-3 bg-light border-4 border-bottom bg-gradient">
                        <div class="col-12 mb-3">
                            <div class="row">
                        <div class="col-lg-2">
                            <i class="fa-solid fa-star" style="color: #7e7f81;font-size: 25px"></i>
                        </div>
                        <div class="col-lg-8">
                            <p>Starred Messages</p>
                        </div>
                        <div class="col-lg-2">
                            <i class="fa-solid fa-angle-right" style="color: #7e7f81;"></i>
                        </div>
                        </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="row">
                        <div class="col-lg-2">
                            <i class="fa-solid fa-bell" style="color: #7e7f81;font-size: 25px"></i>
                        </div>
                        <div class="col-lg-7">
                            <p>Mute Notification</p>
                        </div>
                        <div class="col-lg-3 ps-4">
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider round"></span>
                              </label>
                        </div>
                        </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="row">
                        <div class="col-lg-2">
                            <i class="fa-solid fa-ban " style="color: #ee4444;font-size: 25px"></i>                            
                        </div>
                        <div class="col-lg-8">
                            <p>Block contact</p>
                        </div>
                        <div class="col-lg-2">
                            
                        </div>
                        </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="row">
                        <div class="col-lg-2">
                            <i class="fa-solid fa-thumbs-down fa-flip-horizontal" style="color: #ee4444;font-size: 25px"></i>
                                                 
                        </div>
                        <div class="col-lg-8">
                            <p>Report contact</p>
                        </div>
                        <div class="col-lg-2">
                            
                        </div>
                        </div>
                        </div>
                        <div class="col-12 pb-4 ">
                            <div class="row">
                        <div class="col-lg-2">                           
                            <i class="fa-solid fa-trash" style="color: #ee4444;font-size: 25px"></i>                                                 
                        </div>
                        <div class="col-lg-8">
                            <p>Delete Chat</p>
                        </div>
                        <div class="col-lg-2">
                            
                        </div>
                        </div>
                        </div>
                    </div>
                    
                </div>
               </div>                               
        </div>
    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script>
const socket = io.connect('http://localhost:3000');
socket.on('receive-message', (messageData) => {
    // Update the chat UI when a new message is received
    updateChatUIWithNewMessage(messageData);
});

function sendMessage(messageData) {
    socket.emit('new-message', messageData);
}

async function chatData(event) {
    const selectedUserId = localStorage.getItem('selectedUserId'); 
    const token = localStorage.getItem('token');
    const decodedToken = parseJwt(token);
const currentUserId = decodedToken.userId;
    event.preventDefault();
    const message = document.getElementById('message').value;
    const selectedGroupId = localStorage.getItem('selectedGroupId');

    const obj = {
        message,
        groupId: selectedGroupId || null,
        userId: currentUserId,  
    recipientId: selectedUserId 


    };
    console.log("this is obj", obj);
    
    const fileInput = document.getElementById('chatFile');
    const file = fileInput.files[0];
    const formData = new FormData();

    formData.append("message", message);
    formData.append("file", file);

    try {
        const token = localStorage.getItem('token');
        const response = await axios.post('http://localhost:3000/chat', formData, {
        headers: {
            'Authorization': token,
            'Content-Type': 'multipart/form-data'
        }
    });   console.log("this is chat post response", response.data);
        sendMessage(obj);
        fetchAndDisplayChatData();
    } catch (err) {
        console.log(err);
    }
}
   
// function sendMessage(messageData) {
//     // Emitting the message to the WebSocket server
//     socket.emit('new-message', messageData);
//     // Join the group if it's a group chat
//     if(messageData.groupId) {
//         socket.emit('join-group', messageData.groupId);
//     }
// }


window.addEventListener('DOMContentLoaded', () => {
    setInterval(updateChatUI, 1000);  // Call the function every 1 second
    localStorage.removeItem('selectedGroupId');
    localStorage.removeItem('selectedUserId');
});




const max_msg = 5;

async function fetchAndDisplayChatData() {
    const selectedGroupId = localStorage.getItem('selectedGroupId');
    const selectedUserId = localStorage.getItem('selectedUserId');

    let url, dataKey;
    if (selectedGroupId) {
        url = `http://localhost:3000/chat/group/${selectedGroupId}`;
        dataKey = 'messages';
    } else if (selectedUserId) {
        url = `http://localhost:3000/chat/user/${selectedUserId}`;
        dataKey = 'messages'; 
    } else {
        url = 'http://localhost:3000/chat/user';
        dataKey = 'allChatData';
    }

    console.log("dataKey:", dataKey);

    try {
        const token = localStorage.getItem('token');
        const response = await axios.get(url, { headers: { "Authorization": token } });
        console.log("API Response:", response);

        if (response.status === 200) {
            const data = response.data[dataKey];
            console.log("Fetched chat data:", data);
            const lastMessages = data.slice(-max_msg);
            localStorage.setItem('lastMessages', JSON.stringify(lastMessages));
        } else {
            throw new Error();
        }
    } catch (err) {
        console.log(err);
    }
}

function updateChatUI() {
    const messagescreen = document.getElementById('messagebox');
    messagescreen.innerHTML = ''; // Clear existing messages
    let messages = JSON.parse(localStorage.getItem('lastMessages'));
    const token = localStorage.getItem('token');
    const decodeToken = parseJwt(token);
    messages.forEach(chat => {
        if (chat.userId == decodeToken.userId) {
            const divItem = document.createElement('div');
            divItem.style.border = '1px solid black';
            divItem.style.width = '40%';
            divItem.style.padding = '10px 10px';
            divItem.style.margin = '12px 5px';
            divItem.style.borderRadius = '0px 12px 10px 10px';
            divItem.style.backgroundColor = '#fdfdfd';

            const listItem = document.createElement('li');
            listItem.style.listStyle = 'none';
            listItem.textContent = chat.message;

            const time = document.createElement('p');
            time.style.margin = '0px';
            time.style.padding = '0px';
            time.classList = 'text-end';
            const createdAt = new Date(chat.createdAt);
            const formattedTime = `${createdAt.getDate()}-${createdAt.getMonth() + 1} ${createdAt.getHours()}:${createdAt.getMinutes()}`;
            time.textContent = formattedTime;

            divItem.appendChild(listItem);
            divItem.appendChild(time);
            messagescreen.appendChild(divItem);
        }
    });
}


function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
}

function userProfileVisible(){
    const token=localStorage.getItem('token')
        const decodeToken=parseJwt(token)       
        console.log(decodeToken.name)
        const profilename=document.getElementById('userprofilename')
        childelement=document.createElement('h6')
        childelement.style.textTransform='Uppercase'
        childelement.textContent=decodeToken.name
        profilename.appendChild(childelement)
}

userProfileVisible()     

let max_user=5
async function userlist() {
    try {
        const token=localStorage.getItem('token')
        const decodeToken=parseJwt(token)  
        const parentElement = document.getElementById('alluserlist');
        const response = await axios.get('http://localhost:3000/user/alluser');
        const data = response.data.allUserData;
        const allusersdata= data.slice(-max_user);
            localStorage.setItem('alluserdetails', JSON.stringify(allusersdata));
        if (response.status === 200) {            
            console.log(data);
            const userimgdiv = document.getElementById('onlineuserimg');
            const useronlinename=document.getElementById('onlineusername')
            const userdivright=document.getElementById('useronline')
            
            data.forEach(user => {
                if(user.name!=decodeToken.name){
                const img=document.createElement('i')
            img.classList="fa-solid fa-circle-user fs-2 me-2"          
            img.style.padding='0px 0px'
            img.style.color='#206ef3'
                const divItem = document.createElement('li');              
                divItem.style.display = 'block'; 
                divItem.style.padding = '0px 10px';
                divItem.style.margin = '0px 5px';
                divItem.style.border = '1px 0px';

                 //  an anchor tag and set its attributes
                 divItem.appendChild(img)
                 const anchorTag = document.createElement('a');
                 anchorTag.style.textDecoration='none'
                 anchorTag.style.color='black' 
                 anchorTag.style.fontWeight='bold'
                anchorTag.style.textTransform='capitalize'  
                anchorTag.href = '#' + user.name.toLowerCase(); // Set a unique URL using user name
                anchorTag.textContent = user.name;
                anchorTag.setAttribute("data-type", "user");
                // Append the anchor tag to the list item
                anchorTag.addEventListener('click', () => {
                    localStorage.setItem('selectedUserId', user.id);
                    localStorage.removeItem('selectedGroupId');
                    
                    const userchildimg = document.createElement('i');
                    const userchilddiv = document.createElement('h6');
                    const usersubchild=document.createElement('h6')
                    userchildimg.classList = 'fa-solid fa-circle-user fs-1';
                    userchildimg.style.color='#206ef3'
                    userchilddiv.style.textTransform='uppercase'
                    userchilddiv.textContent = user.name;
                    userchilddiv.classList = 'me-4';
                    usersubchild.style.textTransform='uppercase'
                    usersubchild.textContent = user.name;
                    
                    // Clear previous user information
                    userimgdiv.innerHTML = '';
                    useronlinename.innerHTML = '';
                    userdivright.innerHTML = '';
                    
                    userimgdiv.appendChild(userchildimg);
                    useronlinename.appendChild(userchilddiv);
                    userdivright.appendChild(usersubchild)
                    fetchAndDisplayChatData();
                });

                divItem.appendChild(anchorTag);         

                parentElement.appendChild(divItem);
                const lineBreak = document.createElement('br');
                parentElement.appendChild(lineBreak);
            }
            });

        } else {
            throw new Error();
        }
    } catch (err) {
        console.log(err);
    }
}




document.addEventListener("DOMContentLoaded", function() {
    const dropdownItemList = document.getElementById("dropdownItemList");

    const items = JSON.parse(localStorage.getItem('alluserdetails'))
            console.log("items>>",items)
    items.forEach(item => {
      const listItem = document.createElement("li");
      listItem.innerHTML = `
        <a class="dropdown-item" href="#">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${item.name}" id="${item.id}" />
            <label class="form-check-label" for="${item.id}">${item.name}</label>
          </div>
        </a>
      `;
      dropdownItemList.appendChild(listItem);
    });
  });





async function createGroup(event){
        event.preventDefault();
    
        var groupname=document.getElementById('groupname').value 
        const obj={
            name,
            groupname,
            members: getCheckedMembers()
        }
        
        
        try{
        const token = localStorage.getItem('token');
        const response=await axios.post('http://localhost:3000/chat/creategroup',obj,{headers:{'Authorization':token}})
        console.log("this is create group response", response.data.createdgroupdata) 
        data=response.data.createdgroupdata
        localStorage.setItem("groupname",JSON.stringify(data))        
        }
        catch(err){
            console.log("group data error",err)
        }
    }


    function getCheckedMembers() {
  const checkedMembers = [];
  const checkboxes = document.querySelectorAll('.form-check-input[type="checkbox"]');
  
  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      const memberId = checkbox.getAttribute('id');
      checkedMembers.push(memberId);
    }
  });

  return checkedMembers;
}

function selectGroup(groupId) {
    localStorage.setItem('selectedGroupId', groupId);
    localStorage.removeItem('selectedUserId');
    socket.emit('join-group', groupId);  // Joining the group's WebSocket channel
    fetchAndDisplayChatData();
    updateChatUI();
}




async function getGroups() {
    userlist();
    const parentElement = document.getElementById('alluserlist');
    const userimgdiv = document.getElementById('onlineuserimg');
    const useronlinename = document.getElementById('onlineusername');
    const userdivright = document.getElementById('useronline');
    try {
        const token = localStorage.getItem('token');
        const response = await axios.get('http://localhost:3000/chat/getgroup', { headers: { 'Authorization': token } });
        console.log("groups data", response.data.allGroupData);
        data = response.data.allGroupData;
        const messagebox = document.getElementById('messagebox');
        const groupbox = document.getElementById('groupdetails');
        data.forEach(group => {
            const img = document.createElement('i');
            img.classList = "fa-solid fa-people-group fs-4 me-2";
            img.style.border = '1px solid #00a884';
            img.style.borderRadius = '50%';
            img.style.color = '#00a884';
            const divItem = document.createElement('li');
            divItem.style.display = 'block';
            divItem.style.padding = '5px 10px';
            divItem.style.margin = '0px 5px';
            divItem.style.border = '1px 0px';
            divItem.style.color = "black";
            divItem.classList.add('group-item');

            const anchorTag = document.createElement('a');
            anchorTag.style.textDecoration = 'none';
            anchorTag.style.color = 'black';
            anchorTag.style.fontWeight = 'bold';
            anchorTag.style.textTransform = 'capitalize';
            anchorTag.classList.add('group-item');
            anchorTag.href = '#' + group.groupname.toLowerCase();
            anchorTag.textContent = group.groupname;
            anchorTag.setAttribute("data-type", "group");

            anchorTag.addEventListener('click',  () => {
                selectGroup(group.id);
                // userimgdiv.appendChild(img)
                // useronlinename.appendChild(divItem)
                localStorage.setItem('selectedGroupId', group.id);
                localStorage.removeItem('selectedUserId');
                // Clear chat UI
                const messagescreen = document.getElementById('messagebox');
                messagescreen.innerHTML = '';
                // Fetch and display chat data
                fetchAndDisplayChatData();
                // Update chat UI with the latest messages
                updateChatUI();
            });

            divItem.appendChild(img);
            divItem.appendChild(anchorTag);
            parentElement.appendChild(divItem);
            const lineBreak = document.createElement('br');
            parentElement.appendChild(lineBreak);
        });
    } catch (err) {
        console.log("group data error", err);
    }
}

getGroups();






     function status1(event){
        event.preventDefault();
        var name=document.getElementById('statusupdate').value       

        const obj={
            name,
        }        
        localStorage.setItem('statusUpdate',JSON.stringify(obj)) 
        
    }
    updatestatus()    
    function updatestatus(){
        const savedStatus = JSON.parse(localStorage.getItem('statusUpdate'));
        const status = document.getElementById('profilestatusupdate');
        status.textContent = savedStatus.name;
    }

    function logout() {
        socket.disconnect();
    
    localStorage.removeItem('selectedGroupId');
    localStorage.removeItem('selectedUserId');
    localStorage.removeItem('token');
}
document.getElementById('logoutButton').addEventListener('click', logout);




    </script>

 
</body>
</html>